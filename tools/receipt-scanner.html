<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receipt Scanner</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.1.1/tesseract.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div id="app" class="min-h-screen p-4">
        <div class="max-w-md mx-auto">
            <h1 class="text-2xl font-bold mb-6">Receipt Scanner</h1>

            <div id="signin" class="bg-white rounded-lg shadow p-6 mb-4">
                <h2 class="font-semibold mb-4">Ready to scan receipts</h2>
                <p class="text-sm text-gray-700 mb-6">
                    Sign in with Google to connect your spreadsheet and start scanning receipts.
                </p>

                <button onclick="signInWithGoogle()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Sign in with Google
                </button>

                <div class="mt-4 bg-blue-50 border border-blue-200 rounded p-4 text-sm">
                    <p class="font-medium mb-2">Secure OAuth authentication:</p>
                    <ul class="space-y-1 text-gray-700">
                        <li>• No API keys stored on your device</li>
                        <li>• Temporary access tokens</li>
                        <li>• Revoke access anytime</li>
                        <li>• Only accesses permitted sheets</li>
                    </ul>
                </div>
            </div>

            <div id="setup" class="hidden bg-white rounded-lg shadow p-6 mb-4">
                <div class="flex items-center gap-2 mb-4 text-green-600">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    <span>Signed in successfully</span>
                </div>

                <h2 class="font-semibold mb-4">Connect Your Spreadsheet</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Spreadsheet ID</label>
                        <input type="text" id="spreadsheetId" class="w-full p-2 border rounded" placeholder="1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms"/>
                        <p class="text-xs text-gray-500 mt-1">From URL: docs.google.com/spreadsheets/d/[THIS_PART]/edit</p>
                    </div>
                    <button onclick="saveSetup()" class="w-full bg-blue-600 text-white py-2 rounded font-medium hover:bg-blue-700">Continue</button>
                    <button onclick="signOut()" class="w-full text-sm text-red-600 hover:text-red-800">Sign Out</button>
                </div>
                <div class="mt-4 bg-blue-50 border border-blue-200 rounded p-4 text-sm">
                    <p class="font-medium mb-2">Spreadsheet setup:</p>
                    <p class="text-gray-700">Add these headers in row 1:<br/>Date | Merchant | Items | Payment Method | Category | Total | Total JPY | Balance</p>
                </div>
            </div>

            <div id="scanner" class="hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-4">
                    <button onclick="document.getElementById('fileInput').click()" class="w-full bg-blue-600 text-white py-4 rounded-lg font-medium hover:bg-blue-700 flex items-center justify-center gap-2">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                            <circle cx="12" cy="13" r="4"></circle>
                        </svg>
                        Scan Receipt
                    </button>
                    <input type="file" id="fileInput" accept="image/*" capture="environment" onchange="handleImage(event)" class="hidden"/>
                </div>
                <button onclick="signOut()" class="text-sm text-red-600 hover:text-red-800">Sign Out</button>
            </div>

            <div id="processing" class="hidden bg-white rounded-lg shadow p-8 text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                <p class="text-gray-600">Processing receipt...</p>
            </div>

            <div id="review" class="hidden space-y-4">
                <img id="receiptImage" class="w-full rounded-lg shadow"/>
                <div class="bg-white rounded-lg shadow p-4 space-y-3">
                    <h2 class="font-semibold mb-2">Review & Edit</h2>
                    <div><label class="block text-sm font-medium mb-1">Date</label><input type="date" id="date" class="w-full p-2 border rounded"/></div>
                    <div><label class="block text-sm font-medium mb-1">Merchant</label><input type="text" id="merchant" class="w-full p-2 border rounded"/></div>
                    <div><label class="block text-sm font-medium mb-1">Items</label><textarea id="items" class="w-full p-2 border rounded" rows="3"></textarea></div>
                    <div><label class="block text-sm font-medium mb-1">Payment Method</label><select id="paymentMethod" class="w-full p-2 border rounded"><option>Card</option><option>Cash</option><option>Bank Transfer</option></select></div>
                    <div><label class="block text-sm font-medium mb-1">Category</label><select id="category" class="w-full p-2 border rounded"><option>General</option><option>Food & Dining</option><option>Groceries</option><option>Transport</option><option>Shopping</option><option>Entertainment</option><option>Health</option><option>Travel</option><option>Utilities</option><option>Business</option></select></div>
                    <div><label class="block text-sm font-medium mb-1">Currency</label><select id="currency" class="w-full p-2 border rounded" onchange="updateJPYTotal()"><option value="GBP">£ GBP</option><option value="USD">$ USD</option><option value="EUR">€ EUR</option><option value="JPY">¥ JPY</option></select></div>
                    <div><label class="block text-sm font-medium mb-1">Total</label><input type="text" id="total" class="w-full p-2 border rounded" oninput="updateJPYTotal()"/></div>
                    <div><label class="block text-sm font-medium mb-1">Total (JPY)</label><input type="text" id="totalJPY" class="w-full p-2 border rounded bg-gray-50" readonly/><p class="text-xs text-gray-500 mt-1">Auto-calculated from exchange rate</p></div>
                </div>
                <div id="message" class="hidden"></div>
                <div class="flex gap-2">
                    <button onclick="cancelReview()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-300">Cancel</button>
                    <button onclick="saveToSheets()" class="flex-1 bg-green-600 text-white py-3 rounded-lg font-medium hover:bg-green-700">Save to Sheets</button>
                </div>
            </div>
        </div>
    </div>

    <script>
const CLIENT_ID='720589670556-gce0253vihq712s0qodubulc11v7j53i.apps.googleusercontent.com';const SCOPES='https://www.googleapis.com/auth/spreadsheets';const REDIRECT_URI=window.location.href.split('?')[0].split('#')[0];let state={accessToken:null,spreadsheetId:localStorage.getItem('spreadsheetId')||''};window.addEventListener('DOMContentLoaded',()=>{const hash=window.location.hash.substring(1);const params=new URLSearchParams(hash);const token=params.get('access_token');if(token){state.accessToken=token;localStorage.setItem('accessToken',token);localStorage.setItem('tokenTimestamp',Date.now().toString());window.history.replaceState({},document.title,window.location.pathname);showSetup();return}const savedToken=localStorage.getItem('accessToken');const tokenTimestamp=localStorage.getItem('tokenTimestamp');if(savedToken&&tokenTimestamp){const tokenAge=Date.now()-parseInt(tokenTimestamp);if(tokenAge<50*60*1000){state.accessToken=savedToken;showSetup();return}else{localStorage.removeItem('accessToken');localStorage.removeItem('tokenTimestamp')}}document.getElementById('signin').classList.remove('hidden')});function signInWithGoogle(){const authUrl=`https://accounts.google.com/o/oauth2/v2/auth?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=${encodeURIComponent(SCOPES)}&include_granted_scopes=true&prompt=consent`;window.location.href=authUrl}function showSetup(){document.getElementById('signin').classList.add('hidden');document.getElementById('setup').classList.remove('hidden');if(state.spreadsheetId){document.getElementById('spreadsheetId').value=state.spreadsheetId;showScanner()}}function saveSetup(){const spreadsheetId=document.getElementById('spreadsheetId').value.trim();if(!spreadsheetId){alert('Please enter a Spreadsheet ID');return}state.spreadsheetId=spreadsheetId;localStorage.setItem('spreadsheetId',spreadsheetId);showScanner()}function showScanner(){document.getElementById('setup').classList.add('hidden');document.getElementById('scanner').classList.remove('hidden')}function signOut(){state.accessToken=null;state.spreadsheetId='';localStorage.clear();document.getElementById('scanner').classList.add('hidden');document.getElementById('setup').classList.add('hidden');document.getElementById('signin').classList.remove('hidden')}async function handleImage(event){const file=event.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=async(e)=>{const imageData=e.target.result;document.getElementById('receiptImage').src=imageData;document.getElementById('scanner').classList.add('hidden');document.getElementById('processing').classList.remove('hidden');try{const result=await Tesseract.recognize(imageData,'eng');const text=result.data.text;const parsed=parseReceipt(text);document.getElementById('date').value=parsed.date;document.getElementById('merchant').value=parsed.merchant;document.getElementById('items').value=parsed.items;document.getElementById('paymentMethod').value=parsed.paymentMethod;document.getElementById('category').value=parsed.category;const currencyMap={'¥':'JPY','£':'GBP','$':'USD','€':'EUR'};const currencyCode=currencyMap[parsed.currency]||'GBP';document.getElementById('currency').value=currencyCode;document.getElementById('total').value=formatNumber(parsed.total,currencyCode);await updateJPYTotal();document.getElementById('processing').classList.add('hidden');document.getElementById('review').classList.remove('hidden')}catch(err){console.error(err);alert('Failed to process image');document.getElementById('processing').classList.add('hidden');document.getElementById('scanner').classList.remove('hidden')}};reader.readAsDataURL(file)}function parseReceipt(text){const lines=text.split('\n').filter(line=>line.trim());let date=new Date().toISOString().split('T')[0];const datePatterns=[/(\d{4}[\.\-\/]\d{1,2}[\.\-\/]\d{1,2})/,/(\d{1,2}[\.\-\/]\d{1,2}[\.\-\/]\d{4})/,/(\d{1,2}[\.\-\/]\d{1,2}[\.\-\/]\d{2})/];for(const pattern of datePatterns){const match=text.match(pattern);if(match){let dateStr=match[1];if(dateStr.match(/^\d{4}/)){date=dateStr.replace(/\./g,'-').replace(/\//g,'-')}else{const parts=dateStr.split(/[\.\-\/]/);if(parts.length===3){const year=parts[2].length===2?'20'+parts[2]:parts[2];date=`${year}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`}}break}}let merchant='';const merchantPatterns=[/Apple/i,/Starbucks/i,/McDonald/i,/Amazon/i];for(const pattern of merchantPatterns){const match=text.match(pattern);if(match){merchant=match[0];break}}if(!merchant){for(let i=0;i<Math.min(5,lines.length);i++){const line=lines[i].trim();if(line.length>3&&line.length<30&&!line.match(/[\d¥£$€]/)){merchant=line.replace(/[^\w\s\-&]/g,'').trim();if(merchant)break}}}let total='';let currency='¥';const yenPattern=/¥\s*(\d{1,3}(?:[,\.]\d{3})+)/;const yenMatch=text.match(yenPattern);if(yenMatch){currency='¥';total=yenMatch[1].replace(/[,\.]/g,'')}else{const totalPatterns=[/total[:\s]*([£$€])?\s*(\d+[\.,]\d{2})/i,/amount[:\s]*([£$€])?\s*(\d+[\.,]\d{2})/i,/([£$€])\s*(\d+[\.,]\d{2})/];for(const pattern of totalPatterns){const match=text.match(pattern);if(match){currency=match[1]||'£';total=match[2].replace(',','.');break}}}if(!total){const amounts=text.match(/([£$¥€])\s*(\d+(?:[,\.]\d{3})*(?:[\.,]\d{2})?)/g);if(amounts&&amounts.length>0){const largest=amounts.map(a=>{const m=a.match(/([£$¥€])\s*(\d+(?:[,\.]\d{3})*(?:[\.,]\d{2})?)/);const curr=m[1];let amt=m[2];if(curr==='¥'){amt=amt.replace(/[,\.]/g,'')}else{amt=amt.replace(',','.')}return{currency:curr,amount:parseFloat(amt),original:m[2]}}).sort((a,b)=>b.amount-a.amount)[0];currency=largest.currency;total=largest.currency==='¥'?largest.original.replace(/[,\.]/g,''):largest.original.replace(',','.')}}const items=[];const productPatterns=[/AirPods[^,\n]*/i,/iPhone[^,\n]*/i,/iPad[^,\n]*/i,/MacBook[^,\n]*/i,/Apple\s+Watch[^,\n]*/i];for(const pattern of productPatterns){const match=text.match(pattern);if(match){let item=match[0].trim();item=item.replace(/[¥£$€]\s*\d+.*$/,'').trim();if(!item.match(/CREDIT|VISA|Nathan|Paterson/i)&&item.length>3){if(!items.includes(item)){items.push(item)}}}}return{date,merchant:merchant||'Unknown',items:items.slice(0,2).join(', ')||'See receipt',paymentMethod:'Card',category:'General',total:total||'0',currency}}function formatNumber(num,currency){const n=parseFloat(num);if(isNaN(n))return num;if(currency==='JPY'){return Math.round(n).toLocaleString('en-US')}else if(currency==='GBP'||currency==='USD'||currency==='EUR'){return n.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}return num}async function updateJPYTotal(){const totalStr=document.getElementById('total').value.replace(/,/g,'');const total=parseFloat(totalStr)||0;const currency=document.getElementById('currency').value;if(currency==='JPY'){document.getElementById('totalJPY').value=formatNumber(total,'JPY');return}try{const response=await fetch(`https://api.exchangerate-api.com/v4/latest/${currency}`);const data=await response.json();const rate=data.rates.JPY;const jpy=Math.round(total*rate);document.getElementById('totalJPY').value=formatNumber(jpy,'JPY')}catch(err){console.error('Currency conversion failed:',err);document.getElementById('totalJPY').value='0'}}async function saveToSheets(){const totalStr=document.getElementById('total').value.replace(/,/g,'');const totalJPYStr=document.getElementById('totalJPY').value.replace(/,/g,'');const data={date:document.getElementById('date').value,merchant:document.getElementById('merchant').value,items:document.getElementById('items').value,paymentMethod:document.getElementById('paymentMethod').value,category:document.getElementById('category').value,currency:document.getElementById('currency').value,total:totalStr,totalJPY:totalJPYStr};try{const getResponse=await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${state.spreadsheetId}/values/Sheet1!A:H`,{headers:{'Authorization':`Bearer ${state.accessToken}`}});if(!getResponse.ok){if(getResponse.status===401){throw new Error('Session expired. Please sign in again.')}throw new Error('Failed to read spreadsheet.')}const getData=await getResponse.json();const rows=getData.values||[];const lastBalance=rows.length>1?parseFloat(rows[rows.length-1][7].replace(/,/g,''))||0:0;const newBalance=lastBalance-parseFloat(data.totalJPY);const newRow=[data.date,data.merchant,data.items,data.paymentMethod,data.category,`${formatNumber(data.total,data.currency)} ${data.currency}`,formatNumber(data.totalJPY,'JPY'),formatNumber(newBalance,'JPY')];const appendResponse=await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${state.spreadsheetId}/values/Sheet1!A:H:append?valueInputOption=USER_ENTERED`,{method:'POST',headers:{'Authorization':`Bearer ${state.accessToken}`,'Content-Type':'application/json'},body:JSON.stringify({values:[newRow]})});if(!appendResponse.ok){throw new Error('Failed to save to spreadsheet')}showMessage('Receipt saved successfully!','success');setTimeout(()=>cancelReview(),1500)}catch(err){console.error(err);showMessage(err.message,'error');if(err.message.includes('Session expired')){setTimeout(()=>signOut(),2000)}}}function cancelReview(){document.getElementById('review').classList.add('hidden');document.getElementById('scanner').classList.remove('hidden');document.getElementById('fileInput').value=''}function showMessage(text,type){const msg=document.getElementById('message');msg.textContent=text;msg.className=type==='error'?'flex items-center gap-2 text-red-600 text-sm bg-red-50 p-3 rounded':'flex items-center gap-2 text-green-600 text-sm bg-green-50 p-3 rounded';msg.classList.remove('hidden');setTimeout(()=>msg.classList.add('hidden'),5000)}
    </script>
</body>
</html>